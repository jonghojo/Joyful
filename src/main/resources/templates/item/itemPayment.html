<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<th:block layout:fragment="css">
    <link th:href="@{/css/payment.css}" rel="stylesheet">
</th:block>

<th:block layout:fragment="script">

  <script th:inline="javascript">

      $(document).ready(function() {
          // URL에서 dataList 파라미터 추출
          var urlParams = new URLSearchParams(window.location.search);
          var jsonData = JSON.parse(decodeURIComponent(urlParams.get('dataList')));

          // 상품 정보 요청
          $.ajax({
              url: '/getProductDetails',  // 서버에서 상품 정보를 가져오는 API
              method: 'POST',
              data: { cartItemIds: jsonData.map(item => item.cartItemId) },
              success: function(products) {
                  // 상품 정보를 화면에 표시
                  products.forEach(function(product) {
                      $('#productList').append(`
                    <div class="product-item">
                        <img src="${product.image}" alt="${product.name}">
                        <p>${product.name}</p>
                        <p>${product.price}</p>
                    </div>
                `);
                  });
              },
              error: function() {
                  $('#productList').html('<p>상품 정보를 불러오는 데 실패했습니다.</p>');
              }
          });
      });


    document.addEventListener("DOMContentLoaded", function() {
      // 모든 가격 요소에 대해 쉼표 추가 처리
      document.querySelectorAll('.price').forEach(function(element) {
        var price = element.innerText.trim().replace("원", "");  // 원화 기호 제거
        var formattedPrice = Number(price).toLocaleString();  // 쉼표 추가
        element.innerText = formattedPrice + "원";  // 쉼표 추가된 가격 + 원화 기호
      });
    });

    document.addEventListener("DOMContentLoaded", function () {
      // 각 상품의 가격을 쉼표가 포함된 형식으로 업데이트
      document.querySelectorAll('[id^="totalPrice_"]').forEach(function (element) {
        let priceText = element.innerText.replace("원", "").trim();  // '원' 기호를 제거하고 숫자만 추출
        let price = parseInt(priceText.replace(",", ""), 10);  // 쉼표를 제거하고 숫자 변환

        // 쉼표를 추가한 후 다시 '원'을 붙여서 출력
        let formattedPrice = price.toLocaleString();
        element.innerText = formattedPrice + "원";
      });

      // 주문 금액 합계를 갱신
      function getOrderTotalPrice() {
        let totalPrice = 0;

        // 각 상품에 대한 금액을 더함
        document.querySelectorAll('[id^="totalPrice_"]').forEach(function (element) {
          let price = parseInt(element.innerText.replace("원", "").trim().replace(",", ""), 10);  // 쉼표와 '원'을 제거하고 숫자만 추출
          totalPrice += price;
        });

        // 전체 주문 금액에 쉼표 추가
        let formattedTotalPrice = totalPrice.toLocaleString();  // 쉼표 추가
        document.getElementById("orderTotalPrice").innerText = formattedTotalPrice + "원";  // '원' 붙여서 표시
      }

      // 페이지 로딩 시 바로 총 주문 금액을 계산
      getOrderTotalPrice();
    });

  </script>


</th:block>

<div layout:fragment="content">


    <div class="payment_wrap">

        <p class="pay_h2">결제 페이지</p>

        <div class="product_box">

            <div id="productList">
                <!-- 서버에서 받아온 상품 정보가 여기에 표시됩니다. -->
            </div>

          <div class="totalPrice mt-3 bottom total_pay">
            <h3 class="totalPrice">
              총 결제 금액 : <span id="orderTotalPrice" class="text-danger">0원</span>
            </h3>
          </div>

          <div class="delivery-notice">
            <p class="delivery-h4">배송지 정보</p>

            <form action="/" method="POST">
              <div class="delivery-box">

                <div class="delivery-boxin">
                  <label>이름</label>
                  <input type="text" name="name" value="이유리" required>
                </div>

                <div class="delivery-boxin">
                  <label>연락처</label>
                  <input type="tel" name="phone" value="010-1111-1423" required>
                </div>

                <div class="delivery-boxin">
                  <label>주소</label>
                  <input type="text" name="address" value="경기도 수원시 영통구" required>
                </div>

              </div>

              <button type="submit" class="modify_btn">배송지 수정</button>
            </form>

          </div>

          <div class="pay_method">

            <p class="method_h4">결제 방법</p>

            <div class="pay_method_box">

             <p class="kakaopay_img">
               <img src="/image/kakaoPay.png" alt="카카오페이">
             </p>

              <p>계좌이체</p>
              <p>무통장입금</p>
              <p>휴대폰</p>
            </div>
          </div>

          <div class="final_pay">
            <p class="final_h4">결제 방법</p>

            <div class="totalPrice mt-3 bottom total_pay">
              <h3 class="totalPrice">
                총 결제 금액 : <span id="orderTotalPrice2" class="text-danger">0원</span>
              </h3>
            </div>

            <button type="submit" class="payment_btn">결제하기</button>
          </div>

        </div>
    </div>
</div>
